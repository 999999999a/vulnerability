# Apache Spark命令注入

## 编号

暂无

## 介绍

Apache Spark 是一种用于大数据工作负载的分布式开源处理系统。它使用内存中缓存和优化的查询执行方式，可针对任何规模的数据进行快速分析查询。它提供使用 Java、Scala、Python 和 R 语言的开发 API，支持跨多个工作负载重用代码—批处理、交互式查询、实时分析、机器学习和图形处理等。

当 Spark 任务的文件名可控时， `Utils.unpack` 采用命令拼接的形式对 tar 文件进行解压，存在任意命令注入的风险。成功利用此漏洞可实现任意命令执行。

## 影响范围

3.1.2

3.2.1

3.3.0

## 详情介绍

`core/src/main/scala/org/apache/spark/util/Utils.scala` 代码中调用了FileUtil.unTar方法对tar包进行解压

![image-20220330103726011](./images/image-20220330103726011.png)

FileUtil.unTar方法在非windows的环境中调用了unTarUsingTar方法

![image-20220330104319679](./images/image-20220330104319679.png)

[hadoop-common-project/hadoop-common/src/main/java/org/apache/hadoop/fs/FileUtil.java](https://github.com/apache/hadoop/commit/cae749b076f35f0be13a926ee8cfbb7ce4402746#diff-66aa82c274f41b59e09661e4d60fbf9dcb3465c466c1af64ca9826876bbbcef4)  其对文件名拼接之后通过tar命令进行解压，在处理过程中未对文件名进行转义。

![image-20220330104644752](./images/image-20220330104644752.png)

## 详情链接

[https://github.com/apache/spark/commit/057c051285ec32c665fb458d0670c1c16ba536b2](https://github.com/apache/spark/commit/057c051285ec32c665fb458d0670c1c16ba536b2)
